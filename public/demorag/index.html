<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatbot Demo</title>
  <style>
    .response_feed .feed_item_response {
      white-space: pre-wrap;
    }

    .clear_storage_button {
      float: right;
    }

    .message_text {
      width: 100%;
      height: 5em;
    }
  </style>
  <script>
    let running = false;
    let submit_button;
    let message_text;
    let response_feed;
    let clear_storage_button;

    window.addEventListener("load", () => {
      submit_button = document.body.querySelector(".submit_button");
      message_text = document.body.querySelector(".message_text");
      response_feed = document.body.querySelector(".response_feed");
      clear_storage_button = document.body.querySelector(".clear_storage_button");
      initDemoApp();
      //load items from local storage
      renderFromStorage();
    });

    async function renderFromStorage() {
      let items = localStorage.getItem("response_feed");
      try {
        if (items) items = JSON.parse(items);
      } catch (e) {
        items = [];
      }
      if (!items) items = [];

      response_feed.innerHTML = "";
      items.forEach((item, index) => {
        const itemDom = document.createElement("div");
        itemDom.classList.add("feed_item");
        const ticketResponse = item.assist.assist.choices["0"].message.content;
        itemDom.innerHTML = `<div class="feed_item_header">Prompt:
${item.ticket.message}</div>
        <div class="feed_item_response">Response:
${ticketResponse}</div>
          <div class="feed_item_table_wrapper styled_csv_table"></div>`;
        const tblWrapper = itemDom.querySelector(".feed_item_table_wrapper");
        getDocumentTableHTML(item.embeddings.embeddingResult.matches, tblWrapper);
        response_feed.insertBefore(itemDom, response_feed.firstChild);
      });
    }

    function escapeHTML(str) {
      if (str === undefined || str === null) str = "";
      str = str.toString();
      return str.replace(/[&<>'"]/g,
        (match) => {
          switch (match) {
            case "&": return "&amp;";
            case "<": return "&lt;";
            case ">": return "&gt;";
            case "'": return "&#39;";
            case "\"": return "&quot;";
          }

          return match;
        });
    }

    async function pushToStorage(item) {
      let items = localStorage.getItem("response_feed");
      try {
        if (items) items = JSON.parse(items);
      } catch (e) {
        items = [];
      }
      if (!items) items = [];

      items.push(item);
      localStorage.setItem("response_feed", JSON.stringify(items));
      renderFromStorage();
    }

    function initDemoApp() {
      submit_button.addEventListener("click", async () => {
        if (running) return;
        running = true;
        submit_button.innerHTML = "running...";
        let url = `https://us-central1-promptplusai.cloudfunctions.net/lobbyApi/session/external/message`;
        // let url = `http://localhost:5001/promptplusai/us-central1/lobbyApi/session/external/message`;
        const message = message_text.value.trim();
        const body = {
          message,
          apiToken: "bcdc6f90-80f8-49bc-94ed-f82b43305af2",
          sessionId: "07yt1fqvoj9q",
        }
        const fetchResults = await fetch(url, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        });
        const result = await fetchResults.json();
        running = false;
        submit_button.innerHTML = "Submit";

        if (!result) alert("No results");
        if (result.success === false) {
          console.log("error", result);
          alert(result.errorMessage);
        }
        console.log(body, result);
        message_text.value = "";
        pushToStorage(result);
      });

      clear_storage_button.addEventListener("click", () => {
        localStorage.clear();
        renderFromStorage();
      })
    }

    function getDocumentTableHTML(docRowsArray, ele) {
      let fileContent = "<table class=\"query_result_documents_list\">";
      const keys = ["similarity", "id", "url", "title", "text", "copy", "size", "encodingCredits"];
      fileContent += "<tr>";
      fileContent += `<th>row</th>`;
      keys.forEach((key) => fileContent += `<th>${key}</th>`);
      fileContent += "</tr>";

      docRowsArray.forEach((row, index) => {
        fileContent += "<tr>";
        fileContent += `<th>${index + 1}</th>`;
        const newRow = {};
        keys.forEach((key) => {
          let value = row.metadata[key];
          const rawValue = value;
          value = escapeHTML(value);
          if (key === "id") value = row.id;
          if (key === "similarity") value = row.score;
          if (key === "encodingCredits") value = rawValue.toString().substring(0, 6);
          if (key === "size") value = row.metadata.text.length;
          if (key === "url") value = `<a href="${rawValue}" target="_blank">${rawValue}</a>`;
          if (key === "copy") {
            value = `<button data-index="${index}" class="btn btn-secondary 
                       doc_text_copy_btn">json</button>`;
          }
          fileContent += `<td class="table_cell_sizer"><div>${value}</div></td>`;
          newRow[key] = value;
        });
        fileContent += "</tr>";
      });

      fileContent += `</table>`;
      ele.innerHTML = fileContent;
      ele.querySelectorAll(".doc_text_copy_btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const index = btn.dataset.index;
          const row = docRowsArray[index];
          navigator.clipboard.writeText(row.metadata.text);
        });
      });
    }
  </script>
</head>

<body>
  <h1>Demo chatbot</h1>
  <br>
  <button class="clear_storage_button">Clear</button>
  <br>
  <textarea class="message_text"></textarea>
  <button class="submit_button">Submit</button>
  <hr>
  <div class="response_feed"></div>
  <style>
    .feed_item_table_wrapper {
      max-height: 30vh;
      overflow: auto;
    }
    .styled_csv_table {
      width: 100%;
      flex: 1;
      overflow: auto;
      border: solid 1px var(--secondary-color-4);
      margin-bottom: 12px;
      max-height: 50vh;
      min-height: 10vh;
    }
    
    .styled_csv_table table {
  border: solid 1px silver;
  width: 100%;
  position: relative;
}

.styled_csv_table table th {
  background-color: var(--background-accent-5);
  /*
  border-right: solid 1px var(--secondary-color-4);
  border-top: solid 1px var(--secondary-color-4);
  border-bottom: solid 1px var(--secondary-color-4);
  */
  border: solid 1px var(--secondary-color-4);
  padding: 4px;
  text-align: center;
  padding-right: 12px;
}

.styled_csv_table table td {
  white-space: pre-wrap;
  background-color: var(--background-accent);
  /*
  border-right: solid 1px var(--secondary-color-4);
  border-bottom: solid 1px var(--secondary-color-4);
  */
  border: solid 1px var(--secondary-color-4);
  padding: 4px;
  padding-right: 12px;
}

.styled_csv_table tr:first-child th {
  position: sticky;
  top: -1px;
}

.styled_csv_table th:nth-child(6),
.styled_csv_table td:nth-child(6) {
  width: 40%;
}

.styled_csv_table th:nth-child(1) {
  width: 20px;
}

.table_cell_sizer div {
  max-height: 100px;
  overflow: auto;
  padding: 2px;
}

table tr td.table_cell_sizer {
  padding: 0;
  word-break: break-all;
}

    .styled_csv_table table td:nth-child(2),
    .styled_csv_table table td:nth-child(3) {
      word-break: break-all;
    }

    .styled_csv_table table td button {
      word-break: normal;
      white-space: nowrap;
    }

    
.query_result_documents_list td:nth-child(2) {
  padding: 8px;
  width: 22em;
}

.btn i {
  position: relative;
  font-size: 20px;
  top: 4px;
}

  </style>
</body>

</html>